---
title: "ACORN AMR Report"
output: word_document
editor_options: 
  chunk_output_type: console
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(flextable)
library(ggplot2)
library(grid)
library(gridExtra)
```

```{r}
knitr::include_graphics("img_ACORN_logo.png")
```

![ACORN](img_ACORN_logo.png)


ACORN (“A Clinically Oriented antimicrobial Resistance Network”) is intended to generate patient-focused and clinically actionable AMR surveillance data. Details of the ACORN project protocol can be found here: https://wellcomeopenresearch.org/articles/5-13.

ACORN includes data on both community-acquired infections (CAI) and hospital-acquired infections (HAI). The six key ACORN pathogens are the WHO bloodstream infection priority pathogens Acinetobacter baumannii, Escherichia coli, Klebsiella pneumoniae, Staphylococcus aureus, Streptococcus pneumoniae, and Salmonella sp.

This report contains a summary report of patients enrolled into ACORN, their clinical infection syndromes, associated pathogens and resistance profiles, and outcomes. Care should be taken when interpreting rates and AMR profiles where there are small numbers of cases or bacterial isolates: point estimates may be unreliable.”

</hr>

This report was generated the `r Sys.time()` from the **possibly filtered** patient and microbiology datasets in the ACORN App. Using different filter values, you can generate as many reports as required.

```{r eval = TRUE, echo=FALSE, results="asis"}
add_text <- function(text)  paste0(feedback_text, br(), text)

# Summary
start <- patient() %>% nrow()
end <- patient_filter() %>% nrow()
prop <- round(100 * end / start, 0)
if(start == end) feedback_text <- paste0("All ", start, " patients selected")
if(start != end) feedback_text <- paste0(end, " patients selected (", prop, "% of ", start, ")")

# Surveillance Category
if(input$filter_category == "CAI") feedback_text <- add_text("Community Acquired Infections")
if(input$filter_category == "HAI") feedback_text <- add_text("Hospital Acquired Infections")

# Type of ward
if(! identical(input$filter_type_ward, sort(unique(patient()$ward)))) feedback_text <- add_text(paste0("Admitted in ", paste(input$filter_type_ward, collapse = ", "), " wards"))

# Date of enrollment
if(input$filter_enrollment[1] > min(patient()$date_enrollment) | input$filter_enrollment[2] < max(patient()$date_enrollment)) {
  feedback_text <- add_text(paste0("Enrolled between ", input$filter_enrollment[1], " and ", input$filter_enrollment[2]))
}

# Age
if(input$filter_age_min > 0 | input$filter_age_max < 99) {
  feedback_text <- add_text(paste0("Aged ", input$filter_age_min, " to ", input$filter_age_max, " ", input$filter_age_unit))
}
if(! input$filter_age_na) {
  feedback_text <- add_text("Excluding missing ages")
}

# Patient diagnosis
if(length(input$filter_diagnosis) != 3) {
  feedback_text <- add_text(paste0("Patients diagnosed with ", paste(input$filter_diagnosis, collapse = " or "), " only"))
}

# Diagnosis confirmation
if(input$confirmed_diagnosis %in% c("Diagnosis confirmed", "Diagnosis rejected")) feedback_text <- add_text(paste0(input$confirmed_diagnosis, " by clinical outcome"))

# Outcomes
if(input$filter_outcome_clinical & !input$filter_outcome_d28)  feedback_text <- add_text("Patients with clinical outcome")
if(!input$filter_outcome_clinical & input$filter_outcome_d28)  feedback_text <- add_text("Patients with D28-outcome")
if(input$filter_outcome_clinical & input$filter_outcome_d28)  feedback_text <- add_text("Patients with clinical and D28-outcome")

# Comorbidities
if(input$filter_comorb)  feedback_text <- add_text("At least one Comorbidity")
if(input$filter_cancer)  feedback_text <- add_text("With Cancer")
if(input$filter_renal)  feedback_text <- add_text("With Chronic Renal Failure")
if(input$filter_lung)  feedback_text <- add_text("With Chronic Lung Disease")
if(input$filter_diabetes)  feedback_text <- add_text("With Diabetes mellitus")
if(input$filter_malnutrition)  feedback_text <- add_text("With Malnutrition")

# Clinical severity
if(input$filter_clinical_severity)  feedback_text <- add_text("With one qSOFA/Paediatric severity point")

# Prior hospitalisation
if(input$filter_overnight_3months)  feedback_text <- add_text("With prior hospitalisation (in the past three months)")

# Surgery
if(input$filter_surgery_3months)  feedback_text <- add_text("With surgery in the past three months")

# Presence of medical devices
if(input$filter_medical_p_catheter)  feedback_text <- add_text("With Peripheral IV catheter")
if(input$filter_medical_c_catheter)  feedback_text <- add_text("With Central IV catheter")
if(input$filter_medical_u_catheter)  feedback_text <- add_text("With Urinary catheter")
if(input$filter_medical_ventilation)  feedback_text <- add_text("With Intubation / Mechanical ventilation")

# Ward
if(! identical(input$filter_ward, sort(unique(patient()$ward_text))))  feedback_text <- add_text(paste0("Admitted in ", paste(input$filter_ward, collapse = ", "), " wards"))

# Empiric Antibiotics Prescribed
if(! is.null(input$filter_type_antibio)) feedback_text <- add_text(paste0("Prescribed with ", paste(input$filter_type_antibio, collapse = ", ")))

# Return text
return(HTML(feedback_text))
```

```{r}
if(length(input$filter_method_collection) == 2)  feedback_text <- paste0("All specimen types. ")
if(length(input$filter_method_collection) == 1) {
  if(input$filter_method_collection == "blood") feedback_text <- paste0("(Filter) Only Blood specimens.")
  if(input$filter_method_collection == "other_not_blood") feedback_text <- paste0("(Filter) Specimen types: ", paste(input$filter_method_other, collapse = ", "))
}

if(input$first_isolate)  feedback_text <- add_text(". Only first isolate per organism per patient.")

# Return text
return(HTML(feedback_text))
```


# Profile of Patients

## Per Surveillance Category

Type of ward:

```{r}
patient_filter() %>%
  group_by(ward, surveillance_cat) %>%
  summarise(patients = n()) %>%
  ungroup() %>%
  complete(surveillance_cat, ward) %>%
  mutate(patients = replace_na(patients, 0)) %>%
  pivot_wider(names_from = surveillance_cat, values_from = patients) %>%
  
  
  # add totals
  bind_rows(summarise_all(., ~ (if(is.numeric(.)) sum(.) else "Total"))) %>%
  mutate(Total = rowSums(.[-1])) %>%
  
  # create table
  flextable() %>%
  set_header_labels(ward = "") %>%
  autofit()
```

</br>
Age Category:

```{r}
patient_filter() %>%
  mutate(age_category = case_when(
    age < 1 ~ "Less than 1",
    age < 5 ~ "1 to  5",
    TRUE ~ "Above 5")) %>%
  mutate(age_category = factor(age_category, levels = c("Less than 1", "1 to  5", "Above 5"))) %>% 
  group_by(age_category, surveillance_cat) %>%
  summarise(patients = n()) %>%
  ungroup() %>%
  complete(surveillance_cat, age_category) %>%
  mutate(patients = replace_na(patients, 0)) %>%
  pivot_wider(names_from = surveillance_cat, values_from = patients) %>%
  mutate(age_category = as.character(age_category)) %>%
  
  # add totals
  bind_rows(summarise_all(., ~ (if(is.numeric(.)) sum(.) else "Total"))) %>%
  mutate(Total = rowSums(.[-1])) %>%
  
  # create table
  flextable() %>%
  set_header_labels(age_category = "") %>%
  autofit()
```


</br>
Suspected Diagnosis:

```{r}
patient_filter() %>%
  group_by(surveillance_diag, surveillance_cat) %>%
  summarise(patients = n()) %>%
  ungroup() %>%
  complete(surveillance_cat, surveillance_diag) %>%
  mutate(patients = replace_na(patients, 0)) %>%
  pivot_wider(names_from = surveillance_cat, values_from = patients) %>%
  
  # add totals
  bind_rows(summarise_all(., ~ (if(is.numeric(.)) sum(.) else "Total"))) %>%
  mutate(Total = rowSums(.[-1])) %>%
  
  # create table
  flextable() %>%
  set_header_labels(surveillance_diag = "") %>%
  autofit()
```

</br>
Hospital Discharge Status:

```{r}
patient_filter() %>%
  group_by(discharge_status, surveillance_cat) %>%
  summarise(patients = n()) %>%
  ungroup() %>%
  complete(surveillance_cat, discharge_status) %>%
  mutate(patients = replace_na(patients, 0)) %>%
  pivot_wider(names_from = surveillance_cat, values_from = patients) %>%
  
  # add totals
  bind_rows(summarise_all(., ~ (if(is.numeric(.)) sum(.) else "Total"))) %>%
  mutate(discharge_status = replace_na(discharge_status, "Unknown")) %>%
  mutate(Total = rowSums(.[-1])) %>%
  
  # create table
  flextable() %>%
  set_header_labels(discharge_status = "") %>%
  autofit()
```

</br>
Day 28 Status:

```{r}
patient_filter() %>%
  group_by(status_d28, surveillance_cat) %>%
  summarise(patients = n()) %>%
  ungroup() %>%
  complete(surveillance_cat, status_d28) %>%
  mutate(patients = replace_na(patients, 0)) %>%
  pivot_wider(names_from = surveillance_cat, values_from = patients) %>%
  
  # add totals
  bind_rows(summarise_all(., ~ (if(is.numeric(.)) sum(.) else "Total"))) %>%
  mutate(status_d28 = replace_na(status_d28, "Unknown")) %>%
  mutate(Total = rowSums(.[-1])) %>%
  
  # create table
  flextable() %>%
  set_header_labels(status_d28 = "") %>%
  autofit()
```



## Per Diagnosis

Type of ward:

```{r}
patient_filter() %>%
  group_by(ward, surveillance_diag) %>%
  summarise(patients = n()) %>%
  ungroup() %>%
  complete(surveillance_diag, ward) %>%
  mutate(patients = replace_na(patients, 0)) %>%
  pivot_wider(names_from = surveillance_diag, values_from = patients) %>%
  
  
  # add totals
  bind_rows(summarise_all(., ~ (if(is.numeric(.)) sum(.) else "Total"))) %>%
  mutate(Total = rowSums(.[-1])) %>%
  
  # create table
  flextable() %>%
  set_header_labels(ward = "") %>%
  autofit()
```

</br>
Age Category:

```{r}
patient_filter() %>%
  mutate(age_category = case_when(
    age < 28 / 365 ~ "0-27 days",
    age < 1 ~ "1 month to  1 year",
    age < 5 ~ "1 to  5 years",
    TRUE ~ "Above 5 years")) %>%
  mutate(age_category = factor(age_category, levels = c("Less than 1", "1 to  5", "Above 5"))) %>% 
  group_by(age_category, surveillance_diag) %>%
  summarise(patients = n()) %>%
  ungroup() %>%
  complete(surveillance_diag, age_category) %>%
  mutate(patients = replace_na(patients, 0)) %>%
  pivot_wider(names_from = surveillance_diag, values_from = patients) %>%
  mutate(age_category = as.character(age_category)) %>%
  
  # add totals
  bind_rows(summarise_all(., ~ (if(is.numeric(.)) sum(.) else "Total"))) %>%
  mutate(Total = rowSums(.[-1])) %>%
  
  # create table
  flextable() %>%
  set_header_labels(age_category = "") %>%
  autofit()
```

</br>
Hospital Outcome:

```{r}
patient_filter() %>%
  mutate(clinical_outcome = as.character(clinical_outcome)) %>%
  mutate(clinical_outcome = recode(clinical_outcome, "TRUE" = "Hospital Outcome", "FALSE" = "No Hospital Outcome")) %>%
  group_by(clinical_outcome, surveillance_diag) %>%
  summarise(patients = n()) %>%
  ungroup() %>%
  complete(surveillance_diag, clinical_outcome) %>%
  mutate(patients = replace_na(patients, 0)) %>%
  pivot_wider(names_from = surveillance_diag, values_from = patients) %>%
  
  # add totals
  bind_rows(summarise_all(., ~ (if(is.numeric(.)) sum(.) else "Total"))) %>%
  mutate(Total = rowSums(.[-1])) %>%
  
  # create table
  flextable() %>%
  set_header_labels(clinical_outcome = "") %>%
  autofit()
```

</br>
Hospital Discharge Status:

```{r}
patient_filter() %>%
  group_by(discharge_status, surveillance_diag) %>%
  summarise(patients = n()) %>%
  ungroup() %>%
  complete(surveillance_diag, discharge_status) %>%
  mutate(patients = replace_na(patients, 0)) %>%
  pivot_wider(names_from = surveillance_diag, values_from = patients) %>%
  
  # add totals
  bind_rows(summarise_all(., ~ (if(is.numeric(.)) sum(.) else "Total"))) %>%
  mutate(discharge_status = replace_na(discharge_status, "Unknown")) %>%
  mutate(Total = rowSums(.[-1])) %>%
  
  # create table
  flextable() %>%
  set_header_labels(discharge_status = "") %>%
  autofit()
```

</br>
Day 28 Outcome:

```{r}
patient_filter() %>%
  mutate(d28_outcome = as.character(d28_outcome)) %>%
  mutate(d28_outcome = recode(d28_outcome, "TRUE" = "Day 28 Outcome", "FALSE" = "No Day 28 Outcome")) %>%
  group_by(d28_outcome, surveillance_diag) %>%
  summarise(patients = n()) %>%
  ungroup() %>%
  complete(surveillance_diag, d28_outcome) %>%
  mutate(patients = replace_na(patients, 0)) %>%
  pivot_wider(names_from = surveillance_diag, values_from = patients) %>%
  
  # add totals
  bind_rows(summarise_all(., ~ (if(is.numeric(.)) sum(.) else "Total"))) %>%
  mutate(Total = rowSums(.[-1])) %>%
  
  # create table
  flextable() %>%
  set_header_labels(d28_outcome = "") %>%
  autofit()
```

</br>
Day 28 Status:

```{r}
patient_filter() %>%
  group_by(status_d28, surveillance_diag) %>%
  summarise(patients = n()) %>%
  ungroup() %>%
  complete(surveillance_diag, status_d28) %>%
  mutate(patients = replace_na(patients, 0)) %>%
  pivot_wider(names_from = surveillance_diag, values_from = patients) %>%
  
  # add totals
  bind_rows(summarise_all(., ~ (if(is.numeric(.)) sum(.) else "Total"))) %>%
  mutate(status_d28 = replace_na(status_d28, "Unknown")) %>%
  mutate(Total = rowSums(.[-1])) %>%
  
  # create table
  flextable() %>%
  set_header_labels(status_d28 = "") %>%
  autofit()
```


## Blood Cultures

Enrolments with blood cultures / Total enrolments.

```{r}
# Add surveillance category, surveillance diagnosis to microbio
microbio2 <- left_join(microbio_filter() %>%
                         mutate(episode_id = as.character(episode_id)), 
                       patient_filter() %>% select(surveillance_cat, surveillance_diag, episode_id) %>% 
                         mutate(episode_id = as.character(episode_id)),
                       by = 'episode_id')

left_join(
  microbio2 %>%
    filter(specimen_type == "Blood") %>%
    group_by(surveillance_cat, surveillance_diag) %>%
    summarise(blood = n_distinct(episode_id)),  # Number of blood specimen per month of enrollment
  patient_filter() %>%
    group_by(surveillance_cat, surveillance_diag) %>%
    summarise(all = n_distinct(episode_id)),  # Number of episodes per Category / Diagnosis
  by = c("surveillance_cat", "surveillance_diag")) %>%
  mutate(percent = round(100 * blood/all, 1)) %>%
  
  flextable() %>%
  set_header_labels(surveillance_cat = "", surveillance_diag = "", blood = "Enrolments with Blood Culture", all = "Total Enrolments", percent = "% Blood Culture") 
```


## Enrolments with Key Pathogens

The six key pathogens are Acinetobacter baumannii, Escherichia coli, Klebsiella pneumoniae, Staphylococcus aureus, Streptococcus pneumoniae, and Salmonella sp.

Per 1,000 Enrolments

```{r}
# microbio_filter <- function() return(microbio)
# patient_filter <- function() return(patient)

# Add surveillance category, surveillance diagnosis to microbio
microbio2 <- left_join(microbio_filter() %>%
                         mutate(episode_id = as.character(episode_id)), 
                       patient_filter() %>% select(surveillance_cat, surveillance_diag, episode_id) %>% 
                         mutate(episode_id = as.character(episode_id)),
                       by = 'episode_id')

left_join(
  microbio2 %>%
    filter(organism %in% c("Acinetobacter baumannii", "Escherichia coli", "Klebsiella pneumoniae",
                           "Staphylococcus aureus", "Streptococcus pneumoniae", "Salmonella sp")) %>%
    group_by(surveillance_cat, surveillance_diag) %>%
    summarise(episode = n_distinct(episode_id)),
  patient_filter() %>%
    group_by(surveillance_cat, surveillance_diag) %>%
    summarise(all = n_distinct(episode_id)),
  by = c("surveillance_cat", "surveillance_diag")) %>%
  mutate(per1000 = round(1000 * episode/all, 1)) %>%
  
  flextable() %>%
  set_header_labels(surveillance_cat = "", surveillance_diag = "", episode = "Enrolments with key pathogens", all = "Total Enrolments", per1000 = "per 1,000")
```

Per 1,000 blood cultures

```{r}
left_join(
  microbio2 %>%
    filter(organism %in% c("Acinetobacter baumannii", "Escherichia coli", "Klebsiella pneumoniae",
                           "Staphylococcus aureus", "Streptococcus pneumoniae", "Salmonella sp")) %>%
    filter(specimen_type == "Blood") %>%
    group_by(surveillance_cat, surveillance_diag) %>%
    summarise(episode = n_distinct(episode_id)),
  patient_filter() %>%
    group_by(surveillance_cat, surveillance_diag) %>%
    summarise(all = n_distinct(episode_id)),
  by = c("surveillance_cat", "surveillance_diag")) %>%
  mutate(per1000 = round(1000 * episode/all, 1)) %>%
  
  flextable() %>%
  set_header_labels(surveillance_cat = "", surveillance_diag = "", episode = "Enrolments with key pathogens with blood culture", all = "Total Enrolments", per1000 = "per 1,000") 
```


# Key Pathogens

In the following figures, the "Susceptible" and "Intermediate" categories are merged into one category labelled "Susceptible", following EUCAST new definitions of S, I and R from 2019 (http://www.eucast.org/newsiandr/).

```{r}
cols_sir <- c("Resistant" = "#b2182b", "Susceptible" = "#2166ac")

ggplot_sir <- function(mic = microbio_filter(), pat = patient_filter(), corresp = corresp_org_antibio(), organism_input, matching_name_column, title, surv_cat) {
  
  # mic = microbio
  # pat = patient
  # corresp = corresp_org_antibio
  # organism_input = "Streptococcus pneumoniae"
  # matching_name_column = "s_pneumoniae"
  # title = "All Patients"
  # surv_cat = "HAI"
  
  data <- left_join(
    mic,
    pat %>% select(episode_id, surveillance_cat) %>% 
      mutate(episode_id = as.character(episode_id)),
    by = 'episode_id') %>%
    filter(organism %in% organism_input) %>%
    filter(surveillance_cat %in% surv_cat)
  
  nb_isolates <- data %>% nrow()
  
  data <- data %>%
    select(specimen_id, 9:ncol(data)) %>%
    pivot_longer(-specimen_id) %>%
    filter(value %in% c("S", "I", "R")) %>%
    mutate(value = recode(value, S = "Susceptible", I = "Susceptible", R = "Resistant")) %>%
    group_by(name) %>%
    count(value)
  
  total_tested <- data %>%
    group_by(name) %>%
    summarise(total_org = sum(n))
  
  sir_results <- data %>%
    left_join(total_tested, by = "name") %>%
    mutate(percent = round(100*n / total_org, 1))
  
  sir_results <- left_join(sir_results, corresp, by = c('name' = 'antibio_code')) %>%
    filter(UQ(as.symbol(matching_name_column)) == "show")
  
  if(sir_results %>% nrow() == 0) return(
    ggplot() + 
      theme_minimal(base_size = 18) +
      theme(panel.spacing = unit(2, "lines"), panel.grid.minor = element_blank(),
            panel.grid.major.x = element_blank(),
            axis.text.x = element_text(angle = 30, hjust = 1, vjust = 1),
            plot.title = element_text(size = 20),
            legend.position = "top") +
      labs(title = paste0(title, ": No data to display"), y = NULL, x = NULL))
  
  return(
    ggplot(sir_results, aes(x = antibio_name, y = percent, fill = value)) +
      geom_bar(stat = "identity", color = "gray10") +
      labs(x = NULL, y = "Antibio", fill = "Status") +
      scale_fill_manual(values = cols_sir) +
      theme_minimal(base_size = 18) +
      theme(panel.spacing = unit(2, "lines"), panel.grid.minor = element_blank(),
            panel.grid.major.x = element_blank(),
            axis.text.x = element_text(angle = 30, hjust = 1, vjust = 1),
            plot.title = element_text(size = 20),
            legend.position = "top") +
      labs(title = paste0(title, ": ", nb_isolates, " isolates"), y = "%", x = NULL) +
      scale_x_discrete()
    )
}
```


</br>

## Acinetobacter baumannii

```{r dpi = 200, fig.width = 14, fig.height = 12}
org <- "Acinetobacter baumannii"
match <- "a_baumannii"

g1 <- ggplot_sir(organism_input = org, matching_name_column = match, title = "All Infections", surv_cat = c("CAI", "HAI"))

g2 <- ggplot_sir(organism_input = org, matching_name_column = match, title = "Community Acquired Infections", surv_cat = "CAI")

g3 <- ggplot_sir(organism_input = org, matching_name_column = match, title = "Hospital Acquired Infections", surv_cat = "HAI")

t <- textGrob(paste0(org, "\n",
                     "Total of ", microbio_filter() %>% filter(organism == org) %>% nrow(), " isolates."),
              gp = gpar(fontsize = 22))

grid.arrange(t, g1, g2, g3, ncol = 2)
```

## Escherichia coli

```{r dpi = 200, fig.width = 14, fig.height = 12}
org <- "Escherichia coli"
match <- "e_coli"

g1 <- ggplot_sir(organism_input = org, matching_name_column = match, title = "All Infections", surv_cat = c("CAI", "HAI"))

g2 <- ggplot_sir(organism_input = org, matching_name_column = match, title = "Community Acquired Infections", surv_cat = "CAI")

g3 <- ggplot_sir(organism_input = org, matching_name_column = match, title = "Hospital Acquired Infections", surv_cat = "HAI")

t <- textGrob(paste0(org, "\n",
                     "Total of ", microbio_filter() %>% filter(organism == org) %>% nrow(), " isolates."),
              gp = gpar(fontsize = 22))

grid.arrange(t, g1, g2, g3, ncol = 2)
```

## Klebsiella pneumoniae

```{r dpi = 200, fig.width = 14, fig.height = 12}
org <- "Klebsiella pneumoniae"
match <- "k_pneumoniae"

g1 <- ggplot_sir(organism_input = org, matching_name_column = match, title = "All Infections", surv_cat = c("CAI", "HAI"))

g2 <- ggplot_sir(organism_input = org, matching_name_column = match, title = "Community Acquired Infections", surv_cat = "CAI")

g3 <- ggplot_sir(organism_input = org, matching_name_column = match, title = "Hospital Acquired Infections", surv_cat = "HAI")

t <- textGrob(paste0(org, "\n",
                     "Total of ", microbio_filter() %>% filter(organism == org) %>% nrow(), " isolates."),
              gp = gpar(fontsize = 22))

grid.arrange(t, g1, g2, g3, ncol = 2)
```

## Staphylococcus aureus

```{r dpi = 200, fig.width = 14, fig.height = 12}
org <- "Staphylococcus aureus"
match <- "s_aureus"

g1 <- ggplot_sir(organism_input = org, matching_name_column = match, title = "All Infections", surv_cat = c("CAI", "HAI"))

g2 <- ggplot_sir(organism_input = org, matching_name_column = match, title = "Community Acquired Infections", surv_cat = "CAI")

g3 <- ggplot_sir(organism_input = org, matching_name_column = match, title = "Hospital Acquired Infections", surv_cat = "HAI")

t <- textGrob(paste0(org, "\n",
                     "Total of ", microbio_filter() %>% filter(organism == org) %>% nrow(), " isolates."),
              gp = gpar(fontsize = 22))

grid.arrange(t, g1, g2, g3, ncol = 2)
```

## Streptococcus pneumoniae

```{r dpi = 200, fig.width = 14, fig.height = 12}
org <- "Streptococcus pneumoniae"
match <- "s_pneumoniae"

g1 <- ggplot_sir(organism_input = org, matching_name_column = match, title = "All Infections", surv_cat = c("CAI", "HAI"))

g2 <- ggplot_sir(organism_input = org, matching_name_column = match, title = "Community Acquired Infections", surv_cat = "CAI")

g3 <- ggplot_sir(organism_input = org, matching_name_column = match, title = "Hospital Acquired Infections", surv_cat = "HAI")

t <- textGrob(paste0(org, "\n",
                     "Total of ", microbio_filter() %>% filter(organism == org) %>% nrow(), " isolates."),
              gp = gpar(fontsize = 22))

grid.arrange(t, g1, g2, g3, ncol = 2)
```

## Salmonella sp 

(not S. typhi or S. paratyphi)

```{r dpi = 200, fig.width = 14, fig.height = 12}
vec <- unique(microbio_filter()$organism)
org <- vec[str_detect(vec, "Salmonella") & vec != "Salmonella typhi" & vec != "Salmonella paratyphi"]

match <- "salmonella_species"

g1 <- ggplot_sir(organism_input = org, matching_name_column = match, title = "All Infections", surv_cat = c("CAI", "HAI"))

g2 <- ggplot_sir(organism_input = org, matching_name_column = match, title = "Community Acquired Infections", surv_cat = "CAI")

g3 <- ggplot_sir(organism_input = org, matching_name_column = match, title = "Hospital Acquired Infections", surv_cat = "HAI")

t <- textGrob(paste0(org, "\n",
                     "Total of ", microbio_filter() %>% filter(organism == org) %>% nrow(), " isolates."),
              gp = gpar(fontsize = 22))

grid.arrange(t, g1, g2, g3, ncol = 2)
```